const { CULTIVATION_LEVELS } = require('../../utils/cultivationData');
const { EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle, ComponentType } = require('discord.js');

module.exports = {
    name: 'adminbreakthrough',
    aliases: ['abt', 'adminbt'],
    description: 'ƒê·ªôt ph√° l√™n level cao h∆°n m√† kh√¥ng c·∫ßn EXP (ch·ªâ d√†nh cho admin)',
    usage: '!adminbreakthrough [level]',
    examples: [
        '!adminbreakthrough - Xem danh s√°ch c√°c level c√≥ th·ªÉ ƒë·ªôt ph√°',
        '!adminbreakthrough 10 - ƒê·ªôt ph√° l√™n level 10',
        '!adminbreakthrough Luy·ªán Kh√≠ - S∆° K·ª≥ - T·∫ßng 5 - ƒê·ªôt ph√° l√™n level c·ª• th·ªÉ'
    ],
    permissions: 'admin',
    guildOnly: true,
    category: 'cultivation',

    async execute(message, args, client) {
        try {
            // Check if user is admin
            if (!message.member.permissions.has('Administrator')) {
                return message.reply('‚ùå Ch·ªâ c√≥ admin m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh n√†y!');
            }

            const userId = message.author.id;

            // Get or create user cultivation data
            let cultivationUser = await client.prisma.cultivationUser.findUnique({
                where: { userId: userId }
            });

            if (!cultivationUser) {
                cultivationUser = await client.prisma.cultivationUser.create({
                    data: {
                        userId: userId,
                        exp: 0,
                        currentLevel: 'Ph√†m Nh√¢n',
                        messageCount: 0,
                        voiceTime: 0
                    }
                });
            }

            // If no args, show available levels
            if (!args[0]) {
                return this.showLevelsList(message, client, cultivationUser.currentLevel);
            }

            // Parse target level
            let targetLevel = null;
            let targetIndex = -1;

            // Check if it's a number (level index)
            if (!isNaN(args[0])) {
                targetIndex = parseInt(args[0]) - 1; // Convert to 0-based index
                if (targetIndex >= 0 && targetIndex < CULTIVATION_LEVELS.length) {
                    targetLevel = CULTIVATION_LEVELS[targetIndex];
                }
            } else {
                // Search by level name
                const searchTerm = args.join(' ').toLowerCase();
                targetIndex = CULTIVATION_LEVELS.findIndex(level => 
                    level.name.toLowerCase().includes(searchTerm) || 
                    level.name.toLowerCase() === searchTerm
                );
                
                if (targetIndex !== -1) {
                    targetLevel = CULTIVATION_LEVELS[targetIndex];
                }
            }

            if (!targetLevel) {
                return message.reply('‚ùå Kh√¥ng t√¨m th·∫•y tu vi! S·ª≠ d·ª•ng `!adminbreakthrough` ƒë·ªÉ xem danh s√°ch c√°c tu vi.');
            }

            // Get current level index
            const currentIndex = CULTIVATION_LEVELS.findIndex(level => level.name === cultivationUser.currentLevel);
            
            if (currentIndex === -1) {
                return message.reply('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y level hi·ªán t·∫°i trong h·ªá th·ªëng!');
            }

            // Check if target level is valid
            if (targetIndex <= currentIndex) {
                return message.reply(`‚ùå Kh√¥ng th·ªÉ ƒë·ªôt ph√° xu·ªëng tu vi th·∫•p h∆°n ho·∫∑c c√πng tu vi! Tu vi hi·ªán t·∫°i: **${cultivationUser.currentLevel}** (${currentIndex + 1})`);
            }

            // Confirmation dialog
            const confirmEmbed = new EmbedBuilder()
                .setTitle('‚ö° Admin Breakthrough - X√°c nh·∫≠n')
                .setDescription(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë·ªôt ph√° t·ª´ **${cultivationUser.currentLevel}** l√™n **${targetLevel.name}**?`)
                .setColor(0xffd700)
                .addFields([
                    {
                        name: 'üìä Th√¥ng tin ƒë·ªôt ph√°',
                        value: `‚Ä¢ **Tu Vi hi·ªán t·∫°i:** ${cultivationUser.currentLevel} (${currentIndex + 1})\n‚Ä¢ **Tu Vi m·ª•c ti√™u:** ${targetLevel.name} (${targetIndex + 1})\n‚Ä¢ **EXP hi·ªán t·∫°i:** ${cultivationUser.exp.toLocaleString()}\n‚Ä¢ **EXP sau ƒë·ªôt ph√°:** ${targetLevel.exp.toLocaleString()}`,
                        inline: false
                    },
                    {
                        name: 'üéÅ Ph·∫ßn th∆∞·ªüng nh·∫≠n ƒë∆∞·ª£c',
                        value: targetLevel.rewards ? targetLevel.rewards.join(', ') : 'Kh√¥ng c√≥',
                        inline: false
                    },
                    {
                        name: '‚ö†Ô∏è L∆∞u √Ω',
                        value: '‚Ä¢ ƒê√¢y l√† t√≠nh nƒÉng admin ƒë·∫∑c bi·ªát\n‚Ä¢ Kh√¥ng ti√™u t·ªën ƒëan d∆∞·ª£c hay nguy√™n li·ªáu\n‚Ä¢ C√≥ th·ªÉ ƒë·ªôt ph√° l√™n b·∫•t k·ª≥ level n√†o\n‚Ä¢ **EXP s·∫Ω ƒë∆∞·ª£c set th√†nh 9999 ƒë·ªÉ test**',
                        inline: false
                    }
                ])
                .setTimestamp()
                .setFooter({ 
                    text: `Admin Command ‚Ä¢ ${message.author.username}`, 
                    iconURL: message.author.displayAvatarURL() 
                });

            const confirmButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('admin_breakthrough_confirm')
                        .setLabel('‚úÖ X√°c nh·∫≠n ƒë·ªôt ph√°')
                        .setStyle(ButtonStyle.Success),
                    new ButtonBuilder()
                        .setCustomId('admin_breakthrough_cancel')
                        .setLabel('‚ùå H·ªßy b·ªè')
                        .setStyle(ButtonStyle.Danger)
                );

            const reply = await message.reply({ 
                embeds: [confirmEmbed], 
                components: [confirmButtons] 
            });

            // Handle button interactions
            const collector = reply.createMessageComponentCollector({
                componentType: ComponentType.Button,
                time: 60000, // 1 minute
                filter: i => i.user.id === message.author.id
            });

            collector.on('collect', async interaction => {
                if (interaction.customId === 'admin_breakthrough_confirm') {
                    // Perform breakthrough with test EXP
                    await client.prisma.cultivationUser.update({
                        where: { userId: userId },
                        data: {
                            currentLevel: targetLevel.name,
                            exp: 9999 // Set EXP to 9999 for testing
                        }
                    });

                    // Add rewards if any
                    if (targetLevel.rewards && targetLevel.rewards.length > 0) {
                        for (const reward of targetLevel.rewards) {
                            const [itemId, quantity] = reward.split(':');
                            const qty = parseInt(quantity) || 1;
                            
                            // Determine item type
                            let itemType = 'material';
                            if (itemId.startsWith('lt')) {
                                itemType = 'material';
                            } else if (itemId.startsWith('d')) {
                                itemType = 'medicine';
                            }

                            await client.prisma.userInventory.upsert({
                                where: {
                                    userId_itemType_itemId: {
                                        userId: userId,
                                        itemType: itemType,
                                        itemId: itemId
                                    }
                                },
                                update: {
                                    quantity: {
                                        increment: qty
                                    }
                                },
                                create: {
                                    userId: userId,
                                    itemType: itemType,
                                    itemId: itemId,
                                    quantity: qty
                                }
                            });
                        }
                    }

                    const successEmbed = new EmbedBuilder()
                        .setTitle('üåü Admin Breakthrough Th√†nh C√¥ng!')
                        .setDescription(`**${message.author.username}** ƒë√£ ƒë·ªôt ph√° th√†nh c√¥ng!`)
                        .setColor(0x00ff00)
                        .addFields([
                            {
                                name: 'üéâ K·∫øt qu·∫£',
                                value: `‚Ä¢ **Tu Vi m·ªõi:** ${targetLevel.name}\n‚Ä¢ **EXP test:** 9,999\n‚Ä¢ **ƒê√£ nh·∫£y qua:** ${targetIndex - currentIndex} tu vi`,
                                inline: false
                            },
                            {
                                name: 'üéÅ Ph·∫ßn th∆∞·ªüng',
                                value: targetLevel.rewards ? targetLevel.rewards.join(', ') : 'Kh√¥ng c√≥',
                                inline: false
                            },
                            {
                                name: 'üí° H∆∞·ªõng d·∫´n ti·∫øp theo',
                                value: '‚Ä¢ S·ª≠ d·ª•ng `!tuvi` ƒë·ªÉ xem th√¥ng tin tu vi\n‚Ä¢ S·ª≠ d·ª•ng `!testexp` ƒë·ªÉ th√™m EXP test\n‚Ä¢ S·ª≠ d·ª•ng `!dotpha` ƒë·ªÉ test ƒë·ªôt ph√° b√¨nh th∆∞·ªùng',
                                inline: false
                            }
                        ])
                        .setTimestamp()
                        .setFooter({ 
                            text: `Admin Command ‚Ä¢ ${message.author.username}`, 
                            iconURL: message.author.displayAvatarURL() 
                        });

                    await interaction.update({ 
                        embeds: [successEmbed], 
                        components: [] 
                    });
                } else if (interaction.customId === 'admin_breakthrough_cancel') {
                    const cancelEmbed = new EmbedBuilder()
                        .setTitle('‚ùå ƒê√£ h·ªßy Admin Breakthrough')
                        .setDescription('Qu√° tr√¨nh ƒë·ªôt ph√° admin ƒë√£ b·ªã h·ªßy.')
                        .setColor(0xff4444)
                        .setTimestamp()
                        .setFooter({ 
                            text: `Admin Command ‚Ä¢ ${message.author.username}`, 
                            iconURL: message.author.displayAvatarURL() 
                        });

                    await interaction.update({ 
                        embeds: [cancelEmbed], 
                        components: [] 
                    });
                }
            });

            collector.on('end', () => {
                // Disable buttons when expired
                const disabledButtons = new ActionRowBuilder()
                    .addComponents(
                        new ButtonBuilder()
                            .setCustomId('admin_breakthrough_confirm')
                            .setLabel('‚úÖ X√°c nh·∫≠n ƒë·ªôt ph√°')
                            .setStyle(ButtonStyle.Success)
                            .setDisabled(true),
                        new ButtonBuilder()
                            .setCustomId('admin_breakthrough_cancel')
                            .setLabel('‚ùå H·ªßy b·ªè')
                            .setStyle(ButtonStyle.Danger)
                            .setDisabled(true)
                    );
                
                reply.edit({ components: [disabledButtons] }).catch(() => {});
            });

        } catch (error) {
            console.error('Error in adminbreakthrough command:', error);
            await message.reply(`‚ùå L·ªói admin breakthrough: ${error.message}`);
        }
    },

    async showLevelsList(message, client, currentLevel) {
        // Find current level index
        const currentIndex = CULTIVATION_LEVELS.findIndex(level => level.name === currentLevel);
        
        // Create pages showing levels
        const pages = [];
        const levelsPerPage = 10;
        
        for (let i = 0; i < CULTIVATION_LEVELS.length; i += levelsPerPage) {
            const pageEmbed = new EmbedBuilder()
                .setTitle('‚ö° Admin Breakthrough - Danh s√°ch Tu Vi')
                .setDescription('**Ch·ªçn tu vi b·∫°n mu·ªën ƒë·ªôt ph√° ƒë·∫øn (Admin Only):**')
                .setColor(0xff6600)
                .setTimestamp()
                .setFooter({ 
                    text: `Trang ${Math.floor(i / levelsPerPage) + 1}/${Math.ceil(CULTIVATION_LEVELS.length / levelsPerPage)} ‚Ä¢ Admin Command ‚Ä¢ ${message.author.username}`, 
                    iconURL: message.author.displayAvatarURL() 
                });

            let levelsText = '';
            for (let j = i; j < Math.min(i + levelsPerPage, CULTIVATION_LEVELS.length); j++) {
                const level = CULTIVATION_LEVELS[j];
                const levelNumber = j + 1;
                const isCurrent = j === currentIndex;
                const isAvailable = j > currentIndex;
                
                let status = '';
                if (isCurrent) {
                    status = 'üë§ **[HI·ªÜN T·∫†I]**';
                } else if (isAvailable) {
                    status = '‚úÖ C√≥ th·ªÉ ƒë·ªôt ph√°';
                } else {
                    status = 'üìú ƒê√£ qua';
                }
                
                levelsText += `**${levelNumber}.** ${level.name}\n`;
                levelsText += `‚îú EXP: ${level.exp.toLocaleString()}\n`;
                levelsText += `‚îú T·ªâ l·ªá ƒë·ªôt ph√°: ${level.breakRate}%\n`;
                levelsText += `‚îî ${status}\n\n`;
            }

            pageEmbed.addFields({
                name: 'üìã Danh s√°ch Tu Vi',
                value: levelsText,
                inline: false
            });

            if (i === 0) {
                pageEmbed.addFields(                {
                    name: 'üí° H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng',
                    value: '‚Ä¢ `!adminbreakthrough <s·ªë>` - ƒê·ªôt ph√° ƒë·∫øn tu vi theo s·ªë th·ª© t·ª±\n‚Ä¢ `!adminbreakthrough <t√™n tu vi>` - ƒê·ªôt ph√° ƒë·∫øn tu vi theo t√™n\n‚Ä¢ V√≠ d·ª•: `!adminbreakthrough 15` ho·∫∑c `!adminbreakthrough Luy·ªán Kh√≠`\n‚Ä¢ **EXP s·∫Ω ƒë∆∞·ª£c set th√†nh 9999 sau khi ƒë·ªôt ph√° ƒë·ªÉ test**',
                    inline: false
                });
            }

            pages.push(pageEmbed);
        }

        // Create navigation buttons
        const createButtons = (currentPage, totalPages) => {
            const buttons = [];
            
            buttons.push(
                new ButtonBuilder()
                    .setCustomId('admin_levels_prev')
                    .setLabel('‚óÄ Tr∆∞·ªõc')
                    .setStyle(ButtonStyle.Secondary)
                    .setDisabled(currentPage === 0)
            );
            
            buttons.push(
                new ButtonBuilder()
                    .setCustomId('admin_levels_page')
                    .setLabel(`${currentPage + 1}/${totalPages}`)
                    .setStyle(ButtonStyle.Primary)
                    .setDisabled(true)
            );
            
            buttons.push(
                new ButtonBuilder()
                    .setCustomId('admin_levels_next')
                    .setLabel('Sau ‚ñ∂')
                    .setStyle(ButtonStyle.Secondary)
                    .setDisabled(currentPage === totalPages - 1)
            );
            
            return new ActionRowBuilder().addComponents(buttons);
        };

        // Send initial message
        let currentPage = 0;
        const reply = await message.reply({ 
            embeds: [pages[currentPage]], 
            components: [createButtons(currentPage, pages.length)]
        });

        // Handle pagination
        const collector = reply.createMessageComponentCollector({
            componentType: ComponentType.Button,
            time: 300000, // 5 minutes
            filter: i => i.user.id === message.author.id
        });

        collector.on('collect', async interaction => {
            if (interaction.customId === 'admin_levels_prev' && currentPage > 0) {
                currentPage--;
            } else if (interaction.customId === 'admin_levels_next' && currentPage < pages.length - 1) {
                currentPage++;
            }

            await interaction.update({
                embeds: [pages[currentPage]],
                components: [createButtons(currentPage, pages.length)]
            });
        });

        collector.on('end', () => {
            // Disable all buttons when expired
            const disabledButtons = createButtons(currentPage, pages.length);
            disabledButtons.components.forEach(button => {
                if (!button.data.disabled) button.setDisabled(true);
            });
            
            reply.edit({ 
                embeds: [pages[currentPage]], 
                components: [disabledButtons] 
            }).catch(() => {});
        });
    }
};
