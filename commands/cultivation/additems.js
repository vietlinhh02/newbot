const { EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle, ComponentType } = require('discord.js');

module.exports = {
    name: 'additems',
    aliases: ['additem', 'giveitem', 'testitem'],
    description: 'Th√™m v·∫≠t ph·∫©m v√†o inventory ƒë·ªÉ test (ch·ªâ d√†nh cho admin)',
    usage: '!additems [all] ho·∫∑c !additems [itemId] [quantity]',
    examples: [
        '!additems all - Th√™m t·∫•t c·∫£ v·∫≠t ph·∫©m c·∫ßn thi·∫øt ƒë·ªÉ test',
        '!additems d1 10 - Th√™m 10 ƒëan d∆∞·ª£c c·∫•p 1',
        '!additems lt1 50 - Th√™m 50 linh th·∫°ch c·∫•p 1'
    ],
    permissions: 'admin',
    guildOnly: true,
    category: 'cultivation',

    async execute(message, args, client) {
        try {
            // Check if user is admin
            if (!message.member.permissions.has('Administrator')) {
                return message.reply('‚ùå Ch·ªâ c√≥ admin m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh n√†y!');
            }

            const userId = message.author.id;

            // Get or create user cultivation data
            let cultivationUser = await client.prisma.cultivationUser.findUnique({
                where: { userId: userId }
            });

            if (!cultivationUser) {
                cultivationUser = await client.prisma.cultivationUser.create({
                    data: {
                        userId: userId,
                        exp: 0,
                        currentLevel: 'Ph√†m Nh√¢n',
                        messageCount: 0,
                        voiceTime: 0
                    }
                });
            }

            // If no args or "all", add all testing items
            if (!args[0] || args[0].toLowerCase() === 'all') {
                return this.addAllTestItems(message, client, userId);
            }

            // Add specific item
            const itemId = args[0];
            const quantity = parseInt(args[1]) || 1;

            // Validate item ID
            if (!this.isValidItemId(itemId)) {
                return message.reply('‚ùå ID v·∫≠t ph·∫©m kh√¥ng h·ª£p l·ªá! S·ª≠ d·ª•ng:\n‚Ä¢ **d1-d20** cho ƒëan d∆∞·ª£c\n‚Ä¢ **lt1-lt20** cho linh th·∫°ch');
            }

            // Determine item type
            let itemType = 'material';
            let itemName = 'V·∫≠t ph·∫©m kh√¥ng x√°c ƒë·ªãnh';
            
            if (itemId.startsWith('d')) {
                itemType = 'medicine';
                const level = itemId.substring(1);
                itemName = `ƒêan D∆∞·ª£c C·∫•p ${level}`;
            } else if (itemId.startsWith('lt')) {
                itemType = 'material';
                const level = itemId.substring(2);
                itemName = `Linh Th·∫°ch C·∫•p ${level}`;
            }

            // Add item to inventory
            await client.prisma.userInventory.upsert({
                where: {
                    userId_itemType_itemId: {
                        userId: userId,
                        itemType: itemType,
                        itemId: itemId
                    }
                },
                update: {
                    quantity: {
                        increment: quantity
                    }
                },
                create: {
                    userId: userId,
                    itemType: itemType,
                    itemId: itemId,
                    quantity: quantity
                }
            });

            // Success message
            const successEmbed = new EmbedBuilder()
                .setTitle('‚úÖ Th√™m V·∫≠t Ph·∫©m Th√†nh C√¥ng!')
                .setDescription(`**${message.author.username}** ƒë√£ nh·∫≠n ƒë∆∞·ª£c v·∫≠t ph·∫©m test!`)
                .setColor(0x00ff00)
                .addFields([
                    {
                        name: 'üì¶ V·∫≠t ph·∫©m ƒë√£ th√™m',
                        value: `‚Ä¢ **${itemName}** x${quantity.toLocaleString()}`,
                        inline: false
                    },
                                            {
                            name: 'üí° H∆∞·ªõng d·∫´n ti·∫øp theo',
                            value: '‚Ä¢ S·ª≠ d·ª•ng `!tudo` ƒë·ªÉ xem t√∫i ƒë·ªì\n‚Ä¢ S·ª≠ d·ª•ng `!dotpha` ƒë·ªÉ test ƒë·ªôt ph√°\n‚Ä¢ S·ª≠ d·ª•ng `!additems all` ƒë·ªÉ th√™m t·∫•t c·∫£ v·∫≠t ph·∫©m test',
                            inline: false
                        }
                ])
                .setTimestamp()
                .setFooter({ 
                    text: `Admin Command ‚Ä¢ ${message.author.username}`, 
                    iconURL: message.author.displayAvatarURL() 
                });

            await message.reply({ embeds: [successEmbed] });

        } catch (error) {
            console.error('Error in additems command:', error);
            await message.reply(`‚ùå L·ªói th√™m v·∫≠t ph·∫©m: ${error.message}`);
        }
    },

    async addAllTestItems(message, client, userId) {
        const testItems = [
            // ƒêan d∆∞·ª£c t·ª´ c·∫•p 1 ƒë·∫øn 20
            { itemId: 'd1', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 1' },
            { itemId: 'd2', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 2' },
            { itemId: 'd3', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 3' },
            { itemId: 'd4', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 4' },
            { itemId: 'd5', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 5' },
            { itemId: 'd6', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 6' },
            { itemId: 'd7', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 7' },
            { itemId: 'd8', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 8' },
            { itemId: 'd9', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 9' },
            { itemId: 'd10', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 10' },
            { itemId: 'd11', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 11' },
            { itemId: 'd12', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 12' },
            { itemId: 'd13', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 13' },
            { itemId: 'd14', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 14' },
            { itemId: 'd15', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 15' },
            { itemId: 'd16', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 16' },
            { itemId: 'd17', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 17' },
            { itemId: 'd18', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 18' },
            { itemId: 'd19', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 19' },
            { itemId: 'd20', itemType: 'medicine', quantity: 100, name: 'ƒêan D∆∞·ª£c C·∫•p 20' },
            
            // Linh th·∫°ch t·ª´ c·∫•p 1 ƒë·∫øn 20
            { itemId: 'lt1', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 1' },
            { itemId: 'lt2', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 2' },
            { itemId: 'lt3', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 3' },
            { itemId: 'lt4', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 4' },
            { itemId: 'lt5', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 5' },
            { itemId: 'lt6', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 6' },
            { itemId: 'lt7', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 7' },
            { itemId: 'lt8', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 8' },
            { itemId: 'lt9', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 9' },
            { itemId: 'lt10', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 10' },
            { itemId: 'lt11', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 11' },
            { itemId: 'lt12', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 12' },
            { itemId: 'lt13', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 13' },
            { itemId: 'lt14', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 14' },
            { itemId: 'lt15', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 15' },
            { itemId: 'lt16', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 16' },
            { itemId: 'lt17', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 17' },
            { itemId: 'lt18', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 18' },
            { itemId: 'lt19', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 19' },
            { itemId: 'lt20', itemType: 'material', quantity: 100, name: 'Linh Th·∫°ch C·∫•p 20' }
        ];

        const confirmEmbed = new EmbedBuilder()
            .setTitle('üì¶ Th√™m T·∫•t C·∫£ V·∫≠t Ph·∫©m Test - X√°c Nh·∫≠n')
            .setDescription('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th√™m **t·∫•t c·∫£** v·∫≠t ph·∫©m test v√†o inventory?')
            .setColor(0xffd700)
            .addFields([
                {
                    name: 'üìä Danh s√°ch v·∫≠t ph·∫©m s·∫Ω th√™m',
                    value: '‚Ä¢ **ƒêan D∆∞·ª£c C·∫•p 1-20** (m·ªói lo·∫°i 100 c√°i)\n‚Ä¢ **Linh Th·∫°ch C·∫•p 1-20** (m·ªói lo·∫°i 100 c√°i)\n‚Ä¢ **T·ªïng c·ªông:** 40 lo·∫°i v·∫≠t ph·∫©m, 4000 c√°i',
                    inline: false
                },
                {
                    name: '‚ö†Ô∏è L∆∞u √Ω',
                    value: '‚Ä¢ ƒê√¢y l√† ch·ª©c nƒÉng test d√†nh cho admin\n‚Ä¢ V·∫≠t ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m v√†o inventory hi·ªán t·∫°i\n‚Ä¢ C√≥ th·ªÉ s·ª≠ d·ª•ng ƒë·ªÉ test t·∫•t c·∫£ c√°c level ƒë·ªôt ph√°',
                    inline: false
                }
            ])
            .setTimestamp()
            .setFooter({ 
                text: `Admin Command ‚Ä¢ ${message.author.username}`, 
                iconURL: message.author.displayAvatarURL() 
            });

        const confirmButtons = new ActionRowBuilder()
            .addComponents(
                new ButtonBuilder()
                    .setCustomId('add_all_items_confirm')
                    .setLabel('‚úÖ X√°c nh·∫≠n th√™m t·∫•t c·∫£')
                    .setStyle(ButtonStyle.Success),
                new ButtonBuilder()
                    .setCustomId('add_all_items_cancel')
                    .setLabel('‚ùå H·ªßy b·ªè')
                    .setStyle(ButtonStyle.Danger)
            );

        const reply = await message.reply({ 
            embeds: [confirmEmbed], 
            components: [confirmButtons] 
        });

        // Handle button interactions
        const collector = reply.createMessageComponentCollector({
            componentType: ComponentType.Button,
            time: 60000, // 1 minute
            filter: i => i.user.id === message.author.id
        });

        collector.on('collect', async interaction => {
            if (interaction.customId === 'add_all_items_confirm') {
                // Add all test items
                const addedItems = [];
                
                for (const item of testItems) {
                    await client.prisma.userInventory.upsert({
                        where: {
                            userId_itemType_itemId: {
                                userId: userId,
                                itemType: item.itemType,
                                itemId: item.itemId
                            }
                        },
                        update: {
                            quantity: {
                                increment: item.quantity
                            }
                        },
                        create: {
                            userId: userId,
                            itemType: item.itemType,
                            itemId: item.itemId,
                            quantity: item.quantity
                        }
                    });
                    
                    addedItems.push(`‚Ä¢ **${item.name}** x${item.quantity}`);
                }

                const successEmbed = new EmbedBuilder()
                    .setTitle('üåü Th√™m T·∫•t C·∫£ V·∫≠t Ph·∫©m Test Th√†nh C√¥ng!')
                    .setDescription(`**${message.author.username}** ƒë√£ nh·∫≠n ƒë∆∞·ª£c t·∫•t c·∫£ v·∫≠t ph·∫©m test!`)
                    .setColor(0x00ff00)
                    .addFields([
                        {
                            name: 'üì¶ V·∫≠t ph·∫©m ƒë√£ th√™m',
                            value: `**ƒêan D∆∞·ª£c:** C·∫•p 1-20 (m·ªói lo·∫°i 100 c√°i)\n**Linh Th·∫°ch:** C·∫•p 1-20 (m·ªói lo·∫°i 100 c√°i)\n**T·ªïng c·ªông:** 40 lo·∫°i, 4000 c√°i`,
                            inline: false
                        },
                        {
                            name: 'üí° H∆∞·ªõng d·∫´n ti·∫øp theo',
                            value: '‚Ä¢ S·ª≠ d·ª•ng `!tudo` ƒë·ªÉ xem t√∫i ƒë·ªì\n‚Ä¢ S·ª≠ d·ª•ng `!dotpha` ƒë·ªÉ test ƒë·ªôt ph√°\n‚Ä¢ S·ª≠ d·ª•ng `!adminbreakthrough` ƒë·ªÉ ƒë·ªôt ph√° nhanh\n‚Ä¢ S·ª≠ d·ª•ng `!tuvi` ƒë·ªÉ ki·ªÉm tra tu vi hi·ªán t·∫°i',
                            inline: false
                        }
                    ])
                    .setTimestamp()
                    .setFooter({ 
                        text: `Admin Command ‚Ä¢ ${message.author.username}`, 
                        iconURL: message.author.displayAvatarURL() 
                    });

                await interaction.update({ 
                    embeds: [successEmbed], 
                    components: [] 
                });
            } else if (interaction.customId === 'add_all_items_cancel') {
                const cancelEmbed = new EmbedBuilder()
                    .setTitle('‚ùå ƒê√£ H·ªßy Th√™m V·∫≠t Ph·∫©m')
                    .setDescription('ƒê√£ h·ªßy vi·ªác th√™m t·∫•t c·∫£ v·∫≠t ph·∫©m test.')
                    .setColor(0xff4444)
                    .setTimestamp()
                    .setFooter({ 
                        text: `Admin Command ‚Ä¢ ${message.author.username}`, 
                        iconURL: message.author.displayAvatarURL() 
                    });

                await interaction.update({ 
                    embeds: [cancelEmbed], 
                    components: [] 
                });
            }
        });

        collector.on('end', () => {
            // Disable buttons when expired
            const disabledButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('add_all_items_confirm')
                        .setLabel('‚úÖ X√°c nh·∫≠n th√™m t·∫•t c·∫£')
                        .setStyle(ButtonStyle.Success)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId('add_all_items_cancel')
                        .setLabel('‚ùå H·ªßy b·ªè')
                        .setStyle(ButtonStyle.Danger)
                        .setDisabled(true)
                );
            
            reply.edit({ components: [disabledButtons] }).catch(() => {});
        });
    },

    isValidItemId(itemId) {
        // Check if it's a valid medicine ID (d1-d20)
        if (itemId.startsWith('d')) {
            const level = parseInt(itemId.substring(1));
            return level >= 1 && level <= 20;
        }
        
        // Check if it's a valid material ID (lt1-lt20)
        if (itemId.startsWith('lt')) {
            const level = parseInt(itemId.substring(2));
            return level >= 1 && level <= 20;
        }
        
        return false;
    }
}; 